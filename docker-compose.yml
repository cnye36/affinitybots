services:
    langgraph-redis:
        image: redis:alpine
        ports:
            - "6379:6379"  # Expose Redis port for rate limiting
        healthcheck:
            test: redis-cli ping
            interval: 5s
            timeout: 1s
            retries: 5
        volumes:
            - redis-data:/data  # Persist Redis data
        command: redis-server --appendonly yes  # Enable AOF persistence

    langgraph-api:
        image: "affinitybots:latest"
        ports:
            - "8123:8000"  # Map host port 8123 to container port 8000
        depends_on:
            langgraph-redis:
                condition: service_healthy
        env_file:
            - .env
        environment:

            # Point LangGraph to built-in Redis service
            REDIS_URL: redis://langgraph-redis:6379
            REDIS_URI: redis://langgraph-redis:6379
            POSTGRES_URI: postgresql://postgres.lcnkzptzirdcvemvbjan:GMRjt41fMuDShNoV@aws-0-us-west-1.pooler.supabase.com:5432/postgres
            LANGSMITH_API_KEY: ${LANGSMITH_API_KEY}
            LANGSMITH_ENDPOINT: ${LANGSMITH_ENDPOINT}
            LANGSMITH_PROJECT: ${LANGSMITH_PROJECT}
            LANGSMITH_TRACING: ${LANGSMITH_TRACING}
        extra_hosts:
            - "host.docker.internal:host-gateway"

    google-drive-mcp:
        image: "gdrive-mcp-server-gdrive-mcp"
        ports:
            - "3002:3002"
        env_file:
            - .env
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
            interval: 10s
            timeout: 5s
            retries: 3
    
    gmail-mcp-server:
        image: "gmail-mcp-server-2-gmail-mcp-server"
        ports:
            - "3003:3003"
        env_file:
            - .env
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3003/health"]
            interval: 10s
            timeout: 5s
            retries: 3
    
    playwright-mcp:
        build:
            context: ./mcp-servers/playwright-mcp
            dockerfile: Dockerfile
        ports:
            - "3004:3004"
        environment:
            PORT: 3004
            NODE_ENV: production
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3004/health"]
            interval: 10s
            timeout: 5s
            retries: 3
        restart: unless-stopped
    
    slack-mcp:
        build:
            context: ./mcp-servers/generic-wrapper
            dockerfile: Dockerfile
        ports:
            - "3006:3006"
        environment:
            PORT: 3006
            MCP_COMMAND: npx
            MCP_ARGS: "-y @modelcontextprotocol/server-slack"
            SERVER_NAME: slack
            NODE_ENV: production
        env_file:
            - .env
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3006/health"]
            interval: 10s
            timeout: 5s
            retries: 3
        restart: unless-stopped
    
    puppeteer-mcp:
        build:
            context: ./mcp-servers/generic-wrapper
            dockerfile: Dockerfile
        ports:
            - "3007:3007"
        environment:
            PORT: 3007
            MCP_COMMAND: npx
            MCP_ARGS: "-y @modelcontextprotocol/server-puppeteer"
            SERVER_NAME: puppeteer
            NODE_ENV: production
        healthcheck:
            test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3007/health"]
            interval: 10s
            timeout: 5s
            retries: 3
        restart: unless-stopped
    
    # Schedule worker - only needed if self-hosting (not needed for Vercel deployments)
    # For local dev, run separately with: pnpm run schedule:worker:dev
    # For production on Vercel, deploy worker to Railway/Render/Fly.io
    # 
    # schedule-worker:
    #     build:
    #         context: .
    #         dockerfile: Dockerfile
    #     command: pnpm run schedule:worker
    #     depends_on:
    #         langgraph-redis:
    #             condition: service_healthy
    #     env_file:
    #         - .env
    #     environment:
    #         NODE_ENV: production
    #         REDIS_URI: redis://langgraph-redis:6379
    #         REDIS_URL: redis://langgraph-redis:6379
    #         NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-http://localhost:3000}
    #     restart: unless-stopped
    #     extra_hosts:
    #         - "host.docker.internal:host-gateway"

volumes:
    redis-data:

